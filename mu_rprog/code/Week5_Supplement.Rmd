---
title: ECON 6114 - R Programming (Code Supplement)
output:
  html_document:
    toc: true
    theme: spacelab
---

<h1>Week 5 Programming Supplement</h1>

```{r setOpts, echo = FALSE}
knitr::opts_chunk$set(
    eval = TRUE
    , echo = TRUE
    , warning = FALSE
    , message = FALSE
)
```

<h2>How to create an R package</h2>

As I mentioned in the first two weeks of class, there are around 10,000 packages currently on CRAN but MANY more privately-created packages in use by academics, professional data science teams, and hobbyists.

I'd like to demystify the package through an exercise...we are going to build an R package from scratch here in class! Packages are a robust and effective way to share your code with others and to manage dependencies in your code.

[check out this article on how Airbnb uses internal R packages](https://medium.com/airbnb-engineering/using-r-packages-and-education-to-scale-data-science-at-airbnb-906faa58e12d)

<h3>Introducing RquetteBB</h3>

We are going to create a package called `RquetteBB`, a package for fetching, cleaning, and visualizing Marquette basketball statistics.

Before we begin, be sure that you have a few of the mainstream package-building libraries in R. If you don't have any of these in your R library, please install them:

- [devtools](https://cran.r-project.org/web/packages/devtools/index.html) = R wrappers around some command-line tools used to build R packages. Also includes some utilities for installing packages from source code
- [roxygen2](https://cran.r-project.org/web/packages/roxygen2/index.html) = provides a framework for turning specially-formatting comments in R functions into package documentation that you can call with `?`
- [testthat](https://cran.r-project.org/web/packages/testthat/index.html) = a popular library for running unit tests, essentially tests that your code works as it should

```{r getDeps}
library(devtools)
library(roxygen2)
library(testthat)
```

<h3>Building a Package Skeleton</h3>

- An R package requires a particular directory structure, as explained below:
    - `DESCRIPTION` = a file containing information on dependencies, authors, and other useful metadata
    - `NAMESPACE` = an auto-generated file that contains informaiton on the names of objects defined in your package and the names of objects from other packages that your package relies on
    - `LICENSE` = a text file with some statement of the license that applies to the package. Don't stress...this can be informal and goofy.
    - `R/` = a directory with all the ".R" functions that your package exports
    - `tests/testthat` = a directory with all the tests used to verify that your functions are working correctly
    - `tests/testthat.R` = a script that instructs R how to run your unit tests
    - `man/` = a directory with all the documentation that accompanies your functions. The files in here are auto-generated by `roxygen`

<h3>Let's get started!</h3>

We can use `devtools` from R to get a headstart! Please do the following:

1. set your working directory (with `setwd`) to wherever you'd like the package to live. If you're not sure, just do `setwd("~/repos")`
2. run `devtools::create('RquetteBB')`
3. open up `DESCRIPTION` in your text editor of choice
    - change version number to `0.1`
    - put your information (first name, last name, email) in the `Author` section
    - put an informative description in `Description:`
    - change license to `License: file LICENSE`
    - put an informative Title in `Title:`
4. delete `RquetteBB.Rpoj`
5. create a file called `LICENSE`
    - just write the line: `You can use my stuff but you better give me credit!`
6. create the `tests/` and `tests/testthat` directories
    - create a blank R script, `tests/testthat.R`
    - create a blank R script, `tests/testthat/test-my_functions.R`
7. create a blank R script, `R/my_functions.R`

I've provided a shell script you can run to generate this package. If you're curious:

**make_rquettebb_pkg.sh**

```{r makePackage, engine = 'bash', eval = FALSE, echo = TRUE}
# Create the package directory
mkdir -p ~/repos
cd ~/repos

# Create package skeleton
Rscript -e "devtools::create('RquetteBB')"

# Create all the required directories
mkdir -p tests/testthat
mkdir man

# Create all the required files
echo "You can use this but you better cite me!" > LICENSE
touch R/my_functions.R
touch tests/testthat.R
touch tests/testthat/test-my_functions.R
```

<h3>Write Your First Function!</h3>

Next, it's time to add your first function to the package! Some of the items we discuss later (like editing the `DESCRIPTION` file) will really only make sense if we have a least one function in the package.

Open up `R/my_functions.R`. Let's add a function called `NamesToAbbreviations`. We'll use this function later on to create plot labels from players' names.

**RquetteBB/R/my_functions.R**

```{r myFirstFunction, eval = FALSE}
#' @title Names to abbreviations
#' @name NamesToAbbreviations
#' @description This function takes a vector of names and returns a vector of corresponding initials.
NamesToAbbreviations <- function(nameVec){

    # Split on whitespace
    splitNames <- stringr::str_split(
        nameVec
        , pattern = " "
        , simplify = FALSE
    )

    # Grab the first letter of each name and combines
    abbrevs <- purrr::map_chr(splitNames, function(splitName){
        firstInitial <- substr(splitName[1], 1, 1)
        lastInitial  <- substr(splitName[2], 1, 1)
        return(paste0(firstInitial, lastInitial))
    })

    # Return the character vector of abbreviations
    return(abbrevs)
}
```

<h3>You Can Install Your Package with devtools::install_local</h3>

Now that we have a function in the package, we need to generate documentation for the package and install it! Do the following:

1. Set your working directory to the package. e.g. `setwd("~/repos/RquetteBB")`
2. Run `roxygen2::roxygenize()`. This function will populate your `NAMESPACE` file and (if we had written any yet) generate documentation that users could call with `?`
3. Run `devtools::install_local("~/repos/RquetteBB", force = TRUE)` to install the package!
4. Run `rm(list=ls())` to clear your working environment. Restart your R session.
5. Run `library(RquetteBB)` to load the package
6. Run `?NamesToAbbreviations` to see the documentation for that function

Congratulations on creating your first R package! Lots of work still to be done, but you now have a minimum viable product (MVP) of the `RquetteBB` package.

<h3>Document Your Functions with roxygen2</h3>

As you saw when we ran `?NamesToAbbreviations`, the documentation for our package is looking pretty weak right now. In this section, you'll learn how to document your functions with the popular Royxgen package.

Return to `R/my_functions.R`. Right above your function, add some comments like those shown below. Note that the use of an apostrophe (`#'`) is intentional and important here.

**RquetteBB/R/my_functions.R**

```{r firstRoxygenDocs, eval = FALSE}
#' @title Names to abbreviations
#' @name NamesToAbbreviations
#' @description This function takes a vector of names and returns a vector of corresponding initials.
#' @param nameVec A character vector of player names
#' @importFrom purrr map_chr
#' @importFrom stringr str_split
#' @export
NamesToAbbreviations <- function(nameVec){
#...
```

When you've added this information, save `my_functions.R` and re-run `roxygen::roxygenize()`. Now try running `?NamesToAbbreviations` to see your documentation!

These metadata items are called "roxygen comments". Lines in package R files that begin with `#'` are analyzed by the `roxygen2` package when you run `roxygen2::roxygenize()`.

- `@title`: A short description of what the function does
- `@name`: The name of the function
- `@description`: A longer description of what the function does
- `@param`: An explanation of the purpose of a particular function arguments, the types of valid inputs to that function, and the consequences of passing different values to it. You should have one of these items per function argument.
- `@importFrom`: A list of functions from an external library that your particular function needs. These are of the form `@importFrom package_name func1 func2 func3`
- `@export`: Putting this in your roxygen comments tells roxygen to export this function to the package's namespace (so users of your package can call it)

Next, open up `DESCRIPTION` in a text editor of your choice. We need to add these two new dependencies! Under the `Depends:` line, add an `Imports:` blocks like this:

**RquetteBB/DESCRIPTION**
```
Package: RquetteBB
Title: Marquette Basketball Data in R
Version: 0.1
Authors@R: person("James", "Lamb", email = "jaylamb20@gmail.com", role = c("aut", "cre"))
Description: This package can be used to pull, analyze, and visualize Marquette men's basketball data.
Depends: R (>= 3.3.2)
Imports:
    purrr,
    stringr
License: file LICENSE
Encoding: UTF-8
LazyData: true
RoxygenNote: 7.0.2
```

There are [four types](http://r-pkgs.had.co.nz/description.html) of dependency declarations used in R package `DESCRIPTION` files.

- **Depends**: This section holds all things that are checked when someone calls `library()` on your package. Typically this section will just be used to enforce a minimum version of R that users of your package must have. If you put R packages here, they will automatically be loaded with `library()` whenever someone loads your package.
- **Imports**: This section is really important. Imports holds the name of all the packages that your package's functions use. These packages will not be loaded by default when someone calls `library(your_package)` but they will be *installed* when someone tries to install your package.
- **Suggests**: R packages that are used to support your package but aren't needed to run the code. Examples that commonly end up here are `testthat` for writing unit tests and `rmarkdown` for building documentaiton PDFs.
- **LinkingTo**: Irrelevant unless your package has C, C++, or Fortran code in it.

<h3>Write Your First Unit Test</h3>

In software development, it's a best practice to write your code in modular, composible "units". Units are essentially small, related pieces of functionality. It's also common to write tests for these bit of code, commonly referred to as "unit tests".

The main idea behind [unit tests](https://en.wikipedia.org/wiki/Unit_testing) is to try to imagine every possible type of input that a user might try to feed to your function, and then to test that the function does what it should when given that input. These tests are tedious to write at first, but they help you to make chagnes rapidly in the future...you can experiment and innovate with confidence when you know that your tests will catch any mistakes you make!

The preferred unit testing framework in R is Hadley Wickham's `testthat` package. The easiest way to learn this package is just to use it...let's try it out!

Open `tests/testthat/test-my_functions.R` and add the following code.

**RquetteBB/tests/testthat/test-my_functions.R**

```{r someTests, eval = FALSE}
context("Testing RquetteBB functions")

#===== 1. NamesToAbbreviations
test_that("NamesToAbbreviations should return the expected output for simple vectors", {
    someNames <- c("Joe Buck", "Chris Berman", "Michelle Tafoya")
    expect_identical(NamesToAbbreviations(someNames), c("JB", "CB", "MT"))
    expect_true(class(NamesToAbbreviations(someNames)) == "numeric")
})
```

Save this file, the run `devtools::test()` from the console. You should get something like this:

<center><img src="../slides/assets/img/Week5_test_ouptut.png" height=200px, width=400px></center>

The text in white is the "context" you specified. The white dot signifies one passed tests. The number 1 indicates your first test failure. I you had 5 failures and 12 successes you may see somthing like `.1...23...4...5..`. 

It looks like we messed up our second test! We were testing that the result would be numeric, but this funciton will always return a character vector. Change the "numeric" to "character'" in your test file and re-run.

FWIW...the test we just wrote is called an "end-to-end" test. Basically, that means a "test where we didn't do anything weird". End-to-end tests are the most straightfoward, since they just involve testing that the funciton behaves as expected with the expected input type. Other tests (we may write some later) go out of their way to test behavior in particular weird situations.

Now that we're using `testthat`, we should add it to the `Suggests` section in our `DESCRIPTION` file. Open up that file and add this under your `Imports` section.

**RquetteBB/DESCRIPTION**

```
Suggests:
    testthat
```

<h3>Add a Function to Scrape Marquette Basketball Data</h3>

Next, let's add another function. This function, which we'll call `GetData`, should go out to espn.com and scrape down player statistics for any specified season of Marquette basketball.

**RquetteBB/R/my_functions.R**

```{r GetData, eval = FALSE}
#' @title Get Marquette Men's Basketball Data
#' @name GetData
#' @description This function scrapes sports-reference.com and returns some 
#'              player statistics for Marquette's men's basketball team.
#' @param season String indicating which season you want to pull data for. 
#'               e.g. set to "2017" for 2016-17 season stats
#' @importFrom data.table data.table
#' @importFrom htmltab htmltab
#' @export
GetData <- function(season = "2018"){

    # Build URL
    queryURL <- paste0(
        "https://www.sports-reference.com/cbb/schools/marquette/"
        , season
        , ".html"
    )

    # Grab tables from college basketbal reference
    result <- htmltab::htmltab(
        queryURL
        , which = "//table[@id = 'per_game']"
    )

    # Convert to data.table
    statDT <- data.table::as.data.table(result)

    # Coerce all the columns but Player to numeric
    numCols <- setdiff(names(statDT), "Player")
    statDT <- cbind(
        statDT[, "Player"]
        , statDT[, lapply(.SD, as.numeric), .SDcols = numCols]
    )

    # Return the table
    return(statDT)
}
```

Now that we've added a new function, we need to re-do a few thing:

1. Re-run `roxygen2::roxygenize()` to regenerate package documentaiton
2. Add any new packages we've added to the `DESCRIPTION` file
    - for this, we need to add data.table and XML
3. Write unit tests
    - Let's just add one end-to-end test

**RquetteBB/tests/testthat/test-my_functions.R**

```{r tests2, eval = FALSE}
context("Testing RquetteBB functions")

#===== 1. NamesToAbbreviations

# End-to-end test
test_that("NamesToAbbreviations should return the expected output for simple vectors", {
    someNames <- c("Joe Buck", "Chris Berman", "Michelle Tafoya")
    expect_identical(NamesToAbbreviations(someNames), c("JB", "CB", "MT"))
    expect_true(class(NamesToAbbreviations(someNames)) == "character")
})

#===== 2. NamesToAbbreviations

# End-to-end test
test_that("GetData should return a data.table", {
    statDT <- GetData(season = "2018")
    expect_true("data.table" %in% class(statDT))
    expect_true("Player" %in% names(statDT))
})
```

<h3>Add One More Function to Plot Data</h3>

You're doing great! We should add one more function to the package. This function, `CompareOnStats()`, should take a data table of season stats and create a scatterplot showing pairs of statistics for each player. For example, you could use this function to answer the question *Did Marquette's highest scorers also tend to be beter rebounders?*.

You're a pro at adding new functions now, so I won't belabor the points about adding documentation, updating the DESCRIPTION file, etc.. Let's jump straight into an implementation of the funciton:

**RquetteBB/R/my_functions.R**

```{r CompareOnStats, eval = FALSE}
#' @title Scatterplot Comparison of Player Stats
#' @name CompareOnStats
#' @description Given a data.table of Marquette men's basketball statistics, plot a bivariate
#'              scatterplot of player performance on the basis of two statistics
#' @import data.table
#' @importFrom graphics plot text
#' @param statDT A data.table of Marquette season stats, pulled with \code{\link[RquetteBB]{GetData}}
#' @param x_stat A string with the name of the statistic to plot on the x-axis
#' @param y_stat A string with the name of the statistic to plot on the y-axis
#' @param season String indicating which season you pull data for. Used to create plot title 
#' @param useInitials A boolean. If TRUE, player initials will be plotted. If FALSE, full names will be used.
#' @export
CompareOnStats <- function(statDT
                           , x_stat = "PTS"
                           , y_stat = "TRB"
                           , season
                           , useInitials = TRUE
){

    # Create a scatterplot
    plot(
        x = statDT[, get(x_stat)]
        , y = statDT[, get(y_stat)]
        , xlab = x_stat
        , ylab = y_stat
        , type = "p"
        , col = "white"
        , main = paste0(x_stat, " vs. ", y_stat, " (", season, ")")
    )

    # Grab abbreviations from player names if asked
    if (useInitials){
        namesToPlot <- NamesToAbbreviations(statDT[, Player])
    } else {
        namesToPlot <- statDT[, Player]
    }

    # Add those abbreviations to the plot
    text(
        x = statDT[, get(x_stat)]
        , y = statDT[, get(y_stat)]
        , labels = namesToPlot
    )

    return(invisible(NULL))
}
```

<h3>Final Step: Use Our Package to Do Stuff!</h3>

Congratulations on reaching the end of this tutorial. You've now created your first R package! We can use it to do some cool stuff.

```{r echo = TRUE, eval = TRUE}
# Load up our package
library(RquetteBB)

# Plot 2 on top of each other
par(mfrow = c(2, 1))

# Plot the 2002-2003 data
statsDT <- GetData(season = "2003")
CompareOnStats(
    statDT = statsDT
    , "PTS"
    , "TRB"
    , season = "2002-03"
    , useInitials = FALSE
)

# Plot the 2018-2019 data
statsDT <- GetData(season = "2019")
CompareOnStats(
    statDT = statsDT
    , "PTS"
    , "TRB"
    , season = "2018-19"
    , useInitials = FALSE
)

# Reset graphical settings
par(mfrow = c(1, 1))
```

<h3>Additional Resources</h3>

- **writing packages**: [Hillary Parker tutorial](https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/) | [Hadley's R Packages book](http://r-pkgs.had.co.nz/)
- **unit testing**: [Getting Started with testthat](https://journal.r-project.org/archive/2011-1/RJournal_2011-1_Wickham.pdf) | [testthat repo](https://github.com/hadley/testthat) | [testthat docs](https://cran.r-project.org/web/packages/testthat/index.html)
